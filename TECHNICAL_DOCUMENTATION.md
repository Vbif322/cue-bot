# Техническая документация Cue Bot

## Содержание

1. [Обзор системы](#обзор-системы)
2. [Архитектура проекта](#архитектура-проекта)
3. [Модель данных](#модель-данных)
4. [Схемы пользовательских путей](#схемы-пользовательских-путей)
5. [API и команды бота](#api-и-команды-бота)
6. [Бизнес-логика](#бизнес-логика)

---

## Обзор системы

**Cue Bot** — Telegram-бот для автоматизации проведения турниров по бильярду. Система обеспечивает полный цикл управления турниром: от создания и регистрации участников до проведения матчей и определения победителя.

### Технологический стек

- **Runtime**: Node.js
- **Язык**: TypeScript
- **Telegram Bot Framework**: Grammy v1.38.4
- **База данных**: PostgreSQL
- **ORM**: Drizzle ORM v0.45.0
- **Dev tools**: Nodemon, ts-node

### Основные возможности

- Создание и управление турнирами (администраторы)
- Регистрация на турниры (участники)
- Автоматическая генерация турнирной сетки
- Внесение и подтверждение результатов матчей
- Система технических результатов
- Управление ролями (админ, судья, участник)

---

## Архитектура проекта

### Структура директорий

```
cue-bot/
├── src/
│   ├── bot/
│   │   ├── @types/         # TypeScript типы
│   │   ├── handlers/       # Обработчики команд
│   │   │   ├── matchCommands.ts
│   │   │   ├── registrationCommands.ts
│   │   │   ├── roleCommands.ts
│   │   │   └── tournamentCommands.ts
│   │   ├── middleware/     # Middleware (аутентификация)
│   │   ├── ui/            # UI компоненты (клавиатуры, сообщения)
│   │   ├── wizards/       # Мастера создания (турниры)
│   │   ├── commands.ts    # Регистрация команд
│   │   ├── guards.ts      # Защита маршрутов
│   │   ├── permissions.ts # Проверка прав
│   │   └── types.ts       # Общие типы
│   ├── db/
│   │   ├── schema/        # Схемы таблиц
│   │   │   ├── users.ts
│   │   │   ├── tournaments.ts
│   │   │   ├── tournamentParticipants.ts
│   │   │   ├── matches.ts
│   │   │   ├── notifications.ts
│   │   │   └── disqualifications.ts
│   │   ├── db.ts          # Подключение к БД
│   │   └── schema.ts      # Экспорт схем
│   ├── services/          # Бизнес-логика
│   │   ├── bracketGenerator.ts    # Генерация турнирной сетки
│   │   ├── matchService.ts        # Управление матчами
│   │   ├── tournamentService.ts   # Управление турнирами
│   │   ├── notificationService.ts # Уведомления
│   │   └── timeoutService.ts      # Таймауты
│   ├── utils/            # Утилиты
│   │   ├── constants.ts
│   │   └── dateHelpers.ts
│   └── index.ts          # Точка входа
├── drizzle.config.ts     # Конфигурация Drizzle ORM
├── package.json
└── tsconfig.json
```

### Слои приложения

```
┌─────────────────────────────────────────────┐
│         Telegram Bot (Grammy)               │
│              index.ts                       │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│            Middleware Layer                 │
│         (Auth, Context enrichment)          │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           Command Handlers                  │
│  (roleCommands, tournamentCommands, etc.)   │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│           Service Layer                     │
│  (Business logic, data operations)          │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│          Database Layer                     │
│         (Drizzle ORM + PostgreSQL)          │
└─────────────────────────────────────────────┘
```

---

## Модель данных

### Диаграмма базы данных

```
┌─────────────┐
│    users    │
├─────────────┤
│ id (PK)     │◄─────┐
│ telegram_id │      │
│ username    │      │
│ name        │      │
│ surname     │      │
│ role        │      │
│ email       │      │
│ phone       │      │
│ birthday    │      │
└─────────────┘      │
                     │
       ┌─────────────┼─────────────────────────┐
       │             │                         │
       │             │                         │
┌──────▼────────┐    │    ┌──────────────────▼─┐
│  tournaments  │    │    │ tournamentReferees │
├───────────────┤    │    ├────────────────────┤
│ id (PK)       │◄───┼────┤ tournamentId (FK)  │
│ name          │    │    │ userId (FK)        │
│ discipline    │    │    └────────────────────┘
│ format        │    │
│ status        │    │
│ startDate     │    │
│ maxParticipants│   │
│ winScore      │    │
│ createdBy (FK)│────┘
│ rules         │
│ description   │
└───────┬───────┘
        │
        │
┌───────▼─────────────────┐
│ tournamentParticipants  │
├─────────────────────────┤
│ id (PK)                 │
│ tournamentId (FK)       │◄────────┐
│ userId (FK)             │◄────┐   │
│ seed                    │     │   │
│ status                  │     │   │
│ createdAt               │     │   │
└─────────────────────────┘     │   │
                                │   │
┌───────────────┐               │   │
│    matches    │               │   │
├───────────────┤               │   │
│ id (PK)       │               │   │
│ tournamentId  │───────────────┘   │
│ player1Id (FK)│───────────────────┘
│ player2Id (FK)│───────────────────┐
│ winnerId (FK) │───────────────────┤
│ round         │                   │
│ position      │                   │
│ bracketType   │                   │
│ nextMatchId   │                   │
│ player1Score  │                   │
│ player2Score  │                   │
│ status        │                   │
│ reportedBy    │                   │
│ confirmedBy   │                   │
│ startedAt     │                   │
│ completedAt   │                   │
└───────────────┘                   │
                                    │
┌─────────────────────┐             │
│  disqualifications  │             │
├─────────────────────┤             │
│ id (PK)             │             │
│ tournamentId (FK)   │             │
│ userId (FK)         │◄────────────┘
│ reason              │
│ disqualifiedBy (FK) │
└─────────────────────┘
```

### Описание таблиц

#### users
Хранит информацию о пользователях бота.

- **id**: UUID, первичный ключ
- **telegram_id**: Уникальный ID Telegram
- **username**: Имя пользователя в Telegram
- **name**: Имя
- **surname**: Фамилия
- **role**: Роль (`user`, `admin`)
- **email**: Email (опционально)
- **phone**: Телефон (опционально)
- **birthday**: Дата рождения (опционально)

#### tournaments
Информация о турнирах.

- **id**: UUID, первичный ключ
- **name**: Название турнира
- **discipline**: Дисциплина (`snooker`)
- **format**: Формат (`single_elimination`, `double_elimination`, `round_robin`)
- **status**: Статус турнира
  - `draft` - Черновик
  - `registration_open` - Регистрация открыта
  - `registration_closed` - Регистрация закрыта
  - `in_progress` - В процессе
  - `completed` - Завершён
  - `cancelled` - Отменён
- **startDate**: Дата начала
- **maxParticipants**: Максимальное количество участников
- **winScore**: До скольки побед играть
- **createdBy**: Кто создал (FK на users)
- **rules**: Правила (текст)
- **description**: Описание

#### tournamentParticipants
Регистрации участников на турниры.

- **id**: UUID, первичный ключ
- **tournamentId**: FK на tournaments
- **userId**: FK на users
- **seed**: Порядковый номер в сетке
- **status**: Статус регистрации (`pending`, `confirmed`, `cancelled`)
- **createdAt**: Дата регистрации

#### matches
Матчи турниров.

- **id**: UUID, первичный ключ
- **tournamentId**: FK на tournaments
- **player1Id**: FK на users (первый игрок)
- **player2Id**: FK на users (второй игрок)
- **winnerId**: FK на users (победитель)
- **round**: Номер раунда
- **position**: Позиция в сетке
- **bracketType**: Тип сетки (`winners`, `losers`, `grand_final`)
- **nextMatchId**: FK на следующий матч
- **player1Score**: Счёт первого игрока
- **player2Score**: Счёт второго игрока
- **status**: Статус матча
  - `scheduled` - Запланирован
  - `in_progress` - В процессе
  - `pending_confirmation` - Ожидает подтверждения
  - `completed` - Завершён
  - `cancelled` - Отменён
- **reportedBy**: Кто внёс результат
- **confirmedBy**: Кто подтвердил результат
- **isTechnicalResult**: Технический результат
- **technicalReason**: Причина технического результата
- **startedAt**: Время начала
- **completedAt**: Время завершения

#### tournamentReferees
Судьи турниров.

- **tournamentId**: FK на tournaments
- **userId**: FK на users

#### disqualifications
Дисквалификации участников.

- **id**: UUID, первичный ключ
- **tournamentId**: FK на tournaments
- **userId**: FK на users
- **reason**: Причина дисквалификации
- **disqualifiedBy**: Кто дисквалифицировал (FK на users)

---

## Схемы пользовательских путей

### 1. Путь: Первый запуск бота

```
┌─────────────────┐
│  Пользователь   │
│  пишет /start   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│   authMiddleware        │
│   (создаёт запись в БД) │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│   Проверка роли         │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌──────────┐
│ Admin │ │   User   │
└───┬───┘ └────┬─────┘
    │          │
    │          ▼
    │     ┌──────────────────────┐
    │     │ Установка команд     │
    │     │ для пользователя     │
    │     └──────────────────────┘
    │
    ▼
┌──────────────────────┐
│ Установка команд     │
│ для администратора   │
└──────────────────────┘
```

**Описание:**
1. Пользователь отправляет `/start`
2. Middleware `authMiddleware` проверяет наличие пользователя в БД
3. Если пользователя нет - создаётся новая запись с ролью `user`
4. Если роль `admin` - устанавливаются административные команды
5. Отправляется приветственное сообщение

### 2. Путь: Создание турнира (Администратор)

```
┌──────────────────┐
│  /create_tournament │
└─────────┬──────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 1: Ввод названия   │
│ (текстовое сообщение)  │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 2: Ввод даты       │
│ (текстовое сообщение)  │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 3: Выбор дисциплины│
│ (inline кнопки)        │
│ - Снукер               │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 4: Выбор формата   │
│ (inline кнопки)        │
│ - Олимпийская система  │
│ - Двойная элиминация   │
│ - Круговая система     │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 5: Кол-во участников│
│ (inline кнопки)        │
│ - 8, 16, 32, 64, 128   │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Шаг 6: До скольки побед│
│ (inline кнопки)        │
│ - До 2, 3, 4, 5 побед  │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Создание турнира в БД  │
│ Статус: draft          │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────┐
│ Сообщение с кнопкой:   │
│ "Открыть регистрацию"  │
└────────────────────────┘
```

**Точки входа:**
- Команда: `/create_tournament`
- Обработчик: [tournamentCommands.ts:53](src/bot/handlers/tournamentCommands.ts#L53)
- Wizard: [tournamentCreationWizard.ts](src/bot/wizards/tournamentCreationWizard.ts)

**Отмена процесса:**
- Команда `/cancel` в любой момент отменяет создание турнира

### 3. Путь: Открытие регистрации на турнир (Администратор)

```
┌───────────────────────┐
│  /tournaments         │
│  (список турниров)    │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Выбор турнира         │
│ (inline кнопки)       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка турнира      │
│ (статус: draft)       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка:               │
│ "Открыть регистрацию" │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Статус → registration_open │
│ Обновление в БД       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Турнир доступен для   │
│ регистрации участников│
└───────────────────────┘
```

**Точки входа:**
- Callback: `tournament_open_reg:{id}`
- Обработчик: [tournamentCommands.ts:214](src/bot/handlers/tournamentCommands.ts#L214)

### 4. Путь: Регистрация участника на турнир

```
┌───────────────────────┐
│  /tournaments         │
│  (просмотр турниров)  │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Список турниров       │
│ (статус: registration_│
│ open отображается)    │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Выбор турнира         │
│ (inline кнопка)       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка турнира:     │
│ - Название            │
│ - Дисциплина          │
│ - Формат              │
│ - Участников: X/MAX   │
│ - Дата                │
│ - Статус              │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Проверка регистрации  │
└──────────┬────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌────────┐  ┌──────────────┐
│ Зареги-│  │ Не зарегистри-│
│ стриро-│  │ рован         │
│ ван    │  └──────┬────────┘
└────┬───┘         │
     │             ▼
     │    ┌─────────────────┐
     │    │ Проверка мест   │
     │    └────────┬─────────┘
     │             │
     │      ┌──────┴──────┐
     │      │             │
     │      ▼             ▼
     │  ┌────────┐  ┌──────────┐
     │  │ Есть   │  │ Мест нет │
     │  │ места  │  └──────────┘
     │  └───┬────┘
     │      │
     │      ▼
     │  ┌──────────────────┐
     │  │ Кнопка:          │
     │  │ "Участвовать"    │
     │  └───┬──────────────┘
     │      │
     │      ▼
     │  ┌──────────────────┐
     │  │ Создание записи  │
     │  │ в БД (status:    │
     │  │ confirmed)       │
     │  └───┬──────────────┘
     │      │
     ▼      ▼
┌──────────────────┐
│ Кнопка:          │
│ "Отменить        │
│  регистрацию"    │
└──────────────────┘
```

**Точки входа:**
- Команда: `/tournaments` → выбор турнира
- Callback: `reg:join:{tournamentId}` - регистрация
- Callback: `reg:cancel:{tournamentId}` - отмена регистрации
- Обработчик: [registrationCommands.ts:114](src/bot/handlers/registrationCommands.ts#L114)

**Проверки при регистрации:**
1. Турнир существует
2. Статус турнира = `registration_open`
3. Пользователь не зарегистрирован
4. Есть свободные места

### 5. Путь: Закрытие регистрации и запуск турнира (Администратор)

```
┌───────────────────────┐
│  /tournament {id}     │
│  (просмотр турнира)   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка турнира      │
│ (статус: registration_│
│ open)                 │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка админа:        │
│ "Закрыть регистрацию" │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Статус → registration_│
│ closed                │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка админа:        │
│ "Начать турнир"       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Проверки:             │
│ - Минимум 2 участника │
│ - Статус: registration│
│   _closed             │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Диалог подтверждения: │
│ - Кол-во участников   │
│ - Кол-во матчей       │
│ - Кол-во раундов      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка: "Да, начать   │
│ турнир"               │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ 1. Назначение случайных│
│    сидов (seeds)      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ 2. Генерация сетки    │
│    (bracketGenerator) │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ 3. Создание матчей    │
│    в БД               │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ 4. Статус → in_progress│
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Сообщение: "Турнир    │
│ запущен!"             │
│ Кнопка: "Посмотреть   │
│ сетку"                │
└───────────────────────┘
```

**Точки входа:**
- Callback: `tournament_close_reg:{id}` - закрытие регистрации
- Callback: `tournament_start:{id}` - показ подтверждения
- Callback: `tournament_start_confirm:{id}` - запуск турнира
- Обработчик: [tournamentCommands.ts:232-456](src/bot/handlers/tournamentCommands.ts#L232-L456)

**Алгоритм генерации сетки:**
1. Назначение случайных seeds (функция `assignRandomSeeds`)
2. Генерация структуры сетки (функция `generateBracket`)
3. Создание матчей с привязкой к следующим раундам
4. Обновление статуса турнира

### 6. Путь: Просмотр турнирной сетки

```
┌───────────────────────┐
│  /bracket             │
│  (без параметров)     │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Список активных       │
│ турниров              │
│ (статус: in_progress) │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Выбор турнира         │
│ (inline кнопки)       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Сетка турнира:        │
│                       │
│ *Раунд 1:*            │
│ ⏳ @player1 vs @player2│
│ 🎱 @player3 vs @player4│
│                       │
│ *Раунд 2:*            │
│ ⏳ TBD vs TBD          │
│                       │
│ *Финал:*              │
│ ⏳ TBD vs TBD          │
│                       │
│ Кнопки: #1 #2 #3 #4   │
│ (просмотр матчей)     │
│                       │
│ Кнопка: "🔄 Обновить" │
└───────────────────────┘
```

**Легенда статусов матчей:**
- ⏳ - Запланирован (scheduled)
- 🎱 - В процессе (in_progress)
- ⏸️ - Ожидает подтверждения (pending_confirmation)
- ✅ - Завершён (completed)
- ❌ - Отменён (cancelled)

**Точки входа:**
- Команда: `/bracket` или `/bracket {tournamentId}`
- Callback: `bracket:view:{tournamentId}`
- Обработчик: [matchCommands.ts:238-268](src/bot/handlers/matchCommands.ts#L238-L268)

### 7. Путь: Проведение матча и внесение результата

```
┌───────────────────────┐
│  /my_match            │
│  (текущий матч игрока)│
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка матча:       │
│                       │
│ 🎱 Матч #1            │
│ Раунд 1 из 4          │
│                       │
│ @player1              │
│ vs                    │
│ @player2              │
│                       │
│ Статус: ⏳ Ожидает    │
│ начала                │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка:               │
│ "▶️ Начать матч"      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Статус → in_progress  │
│ startedAt = now()     │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Обновлённая карточка: │
│                       │
│ Статус: 🎱 В процессе │
│                       │
│ Кнопка:               │
│ "📝 Внести результат" │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Форма выбора счёта:   │
│                       │
│ @player1 vs @player2  │
│ Игра до: 3 побед      │
│                       │
│ Выберите счёт:        │
│ [3:0] [3:1] [3:2]     │
│ [0:3] [1:3] [2:3]     │
│                       │
│ Кнопка: "❌ Отмена"   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Выбор счёта           │
│ (например, 3:1)       │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Внесение результата:  │
│ - player1Score = 3    │
│ - player2Score = 1    │
│ - winnerId = player1  │
│ - reportedBy = user   │
│ - status → pending_   │
│   confirmation        │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Уведомление сопернику │
│ (TODO: реализовать)   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка для          │
│ репортера:            │
│                       │
│ Счёт: 3:1             │
│ Статус: ⏸️ Ожидает   │
│ подтверждения         │
│                       │
│ Кнопка: "⏳ Ожидание  │
│ подтверждения..."     │
└───────────────────────┘

┌───────────────────────┐
│ Карточка для          │
│ соперника:            │
│                       │
│ Счёт: 3:1             │
│ Статус: ⏸️ Ожидает   │
│ подтверждения         │
│                       │
│ Кнопки:               │
│ "✅ Подтвердить"      │
│ "❌ Оспорить"         │
└──────────┬────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌─────────┐
│Подтверд-│  │Оспорить │
│ить      │  └────┬────┘
└────┬────┘       │
     │            ▼
     │       ┌──────────────┐
     │       │ Статус →     │
     │       │ in_progress  │
     │       │ Обнуление    │
     │       │ результата   │
     │       │ Сообщение:   │
     │       │ "Обратитесь  │
     │       │ к судье"     │
     │       └──────────────┘
     │
     ▼
┌──────────────────┐
│ Статус →         │
│ completed        │
│ confirmedBy = user│
│ completedAt = now│
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Продвижение      │
│ победителя:      │
│ - Обновление     │
│   следующего     │
│   матча          │
│ - Проверка       │
│   завершения     │
│   турнира        │
└──────────────────┘
```

**Точки входа:**
- Команда: `/my_match` - текущий матч игрока
- Callback: `match:start:{id}` - начать матч
- Callback: `match:report:{id}` - открыть форму внесения результата
- Callback: `match:score:{id}:{p1}:{p2}` - выбор счёта
- Callback: `match:confirm:{id}` - подтверждение
- Callback: `match:dispute:{id}` - оспаривание
- Обработчики: [matchCommands.ts:191-576](src/bot/handlers/matchCommands.ts#L191-L576)

**Проверки при внесении результата:**
1. Матч в статусе `in_progress`
2. Пользователь - участник матча
3. Один из счётов = winScore турнира
4. Счёты не могут быть равны winScore одновременно

### 8. Путь: Установка технического результата (Администратор/Судья)

```
┌───────────────────────┐
│  Просмотр матча       │
│  (любым способом)     │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка матча        │
│ (для админа)          │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Кнопка (только admin):│
│ "⚙️ Тех. результат"   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Меню выбора победителя:│
│                       │
│ ⚙️ Технический        │
│ результат             │
│                       │
│ Матч: @player1 vs     │
│ @player2              │
│                       │
│ Выберите победителя:  │
│ "✅ Победа @player1"  │
│ "✅ Победа @player2"  │
│ "❌ Отмена"           │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Выбор победителя      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Установка результата: │
│ - winnerId = выбран   │
│ - player1Score/2Score │
│   = winScore/0        │
│ - isTechnicalResult   │
│   = true              │
│ - technicalReason     │
│   = причина           │
│ - status → completed  │
│ - confirmedBy = admin │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Продвижение победителя│
│ в следующий матч      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Карточка матча:       │
│                       │
│ Статус: ✅ Завершён  │
│ Победитель: @player1  │
│                       │
│ ⚠️ Технический        │
│ результат: Отказ от   │
│ игры                  │
└───────────────────────┘
```

**Точки входа:**
- Callback: `match:tech:{id}` - открыть меню
- Callback: `match:tech_win:{id}:{winnerId}:{reason}` - установить результат
- Обработчик: [matchCommands.ts:587-701](src/bot/handlers/matchCommands.ts#L587-L701)

**Доступные причины:**
- `walkover` - Отказ от игры
- `no_show` - Неявка соперника
- `forfeit` - Добровольный отказ

### 9. Путь: Завершение турнира

```
┌───────────────────────┐
│ Финальный матч        │
│ (nextMatchId = null)  │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Подтверждение         │
│ результата финала     │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ advanceWinner():      │
│ - Проверка nextMatchId│
│ - nextMatchId = null  │
│   → финал             │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ completeTournament(): │
│ - status → completed  │
│ - updatedAt = now()   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Турнир завершён       │
│ Победитель определён  │
└───────────────────────┘
```

**Автоматическое определение:**
- Система автоматически определяет завершение турнира
- При завершении финального матча вызывается `completeTournament`
- Турнир переходит в статус `completed`

### 10. Путь: Управление ролями (Администратор)

```
┌───────────────────────┐
│ /set_admin @username  │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Поиск пользователя:   │
│ - По username         │
│ - По telegram_id      │
└──────────┬────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌──────────┐
│ Найден  │  │ Не найден│
└────┬────┘  └──────────┘
     │
     ▼
┌──────────────────┐
│ Обновление role: │
│ role = "admin"   │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Установка админ- │
│ ских команд для  │
│ пользователя     │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Подтверждение:   │
│ "@user теперь    │
│ администратор"   │
└──────────────────┘

┌───────────────────────┐
│ /remove_admin @user   │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Проверки:             │
│ - Пользователь найден │
│ - Не снимает с себя   │
│ - Является админом    │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Обновление role:      │
│ role = "user"         │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Установка обычных     │
│ команд                │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Подтверждение:        │
│ "@user больше не      │
│ администратор"        │
└───────────────────────┘
```

**Точки входа:**
- Команда: `/set_admin <telegram_id или @username>`
- Команда: `/remove_admin <telegram_id или @username>`
- Обработчик: [roleCommands.ts:35-135](src/bot/handlers/roleCommands.ts#L35-L135)

**Назначение судьи турнира:**
```
┌───────────────────────┐
│ /assign_referee       │
│ {tournament_id}       │
│ @username             │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Проверки:             │
│ - Турнир существует   │
│ - Пользователь найден │
│ - Не является судьей  │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Создание записи в     │
│ tournamentReferees    │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Подтверждение         │
└───────────────────────┘
```

### 11. Путь: Просмотр "Моих турниров"

```
┌───────────────────────┐
│  /my_tournaments      │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Запрос регистраций:   │
│ - userId = текущий    │
│ - status IN (pending, │
│   confirmed)          │
└──────────┬────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌──────────┐
│ Есть    │  │ Нет      │
│ турниры │  │ турниров │
└────┬────┘  └────┬─────┘
     │            │
     │            ▼
     │       ┌──────────────┐
     │       │ Сообщение:   │
     │       │ "Вы не       │
     │       │ зарегистриро-│
     │       │ ваны"        │
     │       │              │
     │       │ Подсказка:   │
     │       │ /tournaments │
     │       └──────────────┘
     │
     ▼
┌──────────────────┐
│ Список турниров: │
│                  │
│ ✅ Турнир 1      │
│    Дата: ...     │
│    Статус: Подтв-│
│    ерждено       │
│                  │
│ ⏳ Турнир 2      │
│    Дата: ...     │
│    Статус: На    │
│    рассмотрении  │
│                  │
│ Кнопки:          │
│ [Турнир 1]       │
│ [Турнир 2]       │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Выбор турнира    │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Карточка турнира │
│ с возможностью   │
│ отменить         │
│ регистрацию      │
└──────────────────┘
```

**Точки входа:**
- Команда: `/my_tournaments`
- Callback: `reg:view:{tournamentId}` - просмотр конкретного турнира
- Обработчик: [registrationCommands.ts:266-343](src/bot/handlers/registrationCommands.ts#L266-L343)

### 12. Путь: Удаление турнира (Администратор)

```
┌───────────────────────┐
│ /delete_tournament    │
└──────────┬────────────┘
           │
           ▼
┌───────────────────────┐
│ Запрос турниров:      │
│ - status IN (draft,   │
│   cancelled)          │
└──────────┬────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌──────────┐
│ Есть    │  │ Нет      │
│ турниры │  │ турниров │
└────┬────┘  └──────────┘
     │
     ▼
┌──────────────────┐
│ Список турниров: │
│ 📝 Турнир 1      │
│ ❌ Турнир 2      │
│                  │
│ Кнопки для       │
│ каждого турнира  │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Выбор турнира    │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Диалог           │
│ подтверждения:   │
│                  │
│ "Вы уверены, что │
│ хотите удалить?" │
│                  │
│ 📋 Турнир X      │
│ Статус: ...      │
│                  │
│ Кнопки:          │
│ "✅ Да, удалить" │
│ "❌ Отмена"      │
└────┬─────────────┘
     │
 ┌───┴───┐
 │       │
 ▼       ▼
┌───┐ ┌──────┐
│Да │ │Отмена│
└─┬─┘ └──────┘
  │
  ▼
┌──────────────────┐
│ Удаление из БД:  │
│ DELETE FROM      │
│ tournaments      │
│ WHERE id = ...   │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Сообщение:       │
│ "🗑 Турнир       │
│ удалён"          │
└──────────────────┘
```

**Точки входа:**
- Команда: `/delete_tournament` или `/delete_tournament {id}`
- Callback: `tournament_delete_confirm:{id}` - показ подтверждения
- Callback: `tournament_delete:{id}` - удаление
- Callback: `tournament_delete_cancel` - отмена
- Обработчик: [tournamentCommands.ts:162-314](src/bot/handlers/tournamentCommands.ts#L162-L314)

**Ограничения:**
- Можно удалить только турниры со статусом `draft` или `cancelled`
- Каскадное удаление связанных данных настроено на уровне БД

---

## API и команды бота

### Команды для пользователей

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/start` | Запуск бота, регистрация | Все |
| `/tournaments` | Список всех турниров | Все |
| `/tournament` | Просмотр турнира | Все |
| `/my_tournaments` | Мои турниры | Все |
| `/my_match` | Текущий активный матч | Участники |
| `/bracket` | Сетка турнира | Все |

### Команды для администраторов

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/create_tournament` | Создать турнир | Админ |
| `/delete_tournament` | Удалить турнир | Админ |
| `/set_admin` | Назначить администратора | Админ |
| `/remove_admin` | Снять администратора | Админ |
| `/assign_referee` | Назначить судью турнира | Админ |
| `/remove_referee` | Снять судью турнира | Админ |

### Callback Query паттерны

#### Регистрация на турниры
- `reg:join:{tournamentId}` - Регистрация
- `reg:cancel:{tournamentId}` - Отмена регистрации
- `reg:view:{tournamentId}` - Просмотр турнира
- `reg:full:{tournamentId}` - Мест нет (заглушка)

#### Управление турнирами
- `tournament_info:{tournamentId}` - Информация о турнире
- `tournament_open_reg:{tournamentId}` - Открыть регистрацию
- `tournament_close_reg:{tournamentId}` - Закрыть регистрацию
- `tournament_start:{tournamentId}` - Показать подтверждение запуска
- `tournament_start_confirm:{tournamentId}` - Запустить турнир
- `tournament_delete_confirm:{tournamentId}` - Показать подтверждение удаления
- `tournament_delete:{tournamentId}` - Удалить турнир
- `tournament_delete_cancel` - Отмена удаления

#### Wizard создания турнира
- `discipline:{discipline}` - Выбор дисциплины
- `format:{format}` - Выбор формата
- `participants:{number}` - Кол-во участников
- `winscore:{number}` - До скольки побед

#### Матчи
- `match:view:{matchId}` - Просмотр матча
- `match:start:{matchId}` - Начать матч
- `match:report:{matchId}` - Форма внесения результата
- `match:score:{matchId}:{p1Score}:{p2Score}` - Выбор счёта
- `match:confirm:{matchId}` - Подтвердить результат
- `match:dispute:{matchId}` - Оспорить результат
- `match:waiting:{matchId}` - Ожидание (заглушка)
- `match:tech:{matchId}` - Меню тех. результата
- `match:tech_win:{matchId}:{winnerId}:{reason}` - Установить тех. результат

#### Сетка
- `bracket:view:{tournamentId}` - Просмотр сетки

---

## Бизнес-логика

### Сервисы

#### tournamentService.ts

Управление турнирами.

**Основные функции:**

- `canStartTournament(tournamentId)` - Проверка возможности запуска
  - Проверяет статус `registration_closed`
  - Минимум 2 участника

- `getConfirmedParticipants(tournamentId)` - Получение подтверждённых участников
  - Статусы: `pending`, `confirmed`
  - Сортировка по дате регистрации

- `startTournament(tournamentId)` - Запуск турнира
  - Изменение статуса на `in_progress`

- `completeTournament(tournamentId, winnerId)` - Завершение турнира
  - Изменение статуса на `completed`

- `assignRandomSeeds(tournamentId)` - Назначение случайных сидов
  - Перемешивание участников
  - Присвоение порядковых номеров

- `updateTournamentStatus(tournamentId, status)` - Обновление статуса
- `deleteTournament(tournamentId)` - Удаление турнира
- `canDeleteTournament(status)` - Проверка возможности удаления

#### matchService.ts

Управление матчами.

**Основные функции:**

- `createMatches(tournamentId, bracket)` - Создание матчей из сгенерированной сетки
  - Двухэтапное создание (сначала матчи, потом связи)

- `getMatch(matchId)` - Получение матча с информацией об игроках
  - Джойны с таблицей users
  - Возвращает полную информацию

- `getPlayerCurrentMatch(tournamentId, userId)` - Текущий матч игрока в турнире
  - Статусы: `scheduled`, `in_progress`, `pending_confirmation`

- `getPlayerActiveMatches(userId)` - Все активные матчи игрока
  - Во всех активных турнирах

- `startMatch(matchId)` - Начало матча
  - Статус `scheduled` → `in_progress`
  - Установка startedAt

- `reportResult(matchId, reporterId, p1Score, p2Score)` - Внесение результата
  - Проверка участия репортера
  - Валидация счёта
  - Определение победителя
  - Статус → `pending_confirmation`

- `confirmResult(matchId, confirmerId)` - Подтверждение результата
  - Проверка, что подтверждает соперник
  - Статус → `completed`
  - Вызов `advanceWinner()`

- `disputeResult(matchId, userId)` - Оспаривание результата
  - Возврат в статус `in_progress`
  - Обнуление результата

- `setTechnicalResult(matchId, winnerId, reason, setById)` - Технический результат
  - Установка победителя
  - Счёт: winScore:0
  - Флаг isTechnicalResult = true
  - Вызов `advanceWinner()`

- `advanceWinner(matchId)` - Продвижение победителя
  - Получение следующего матча (nextMatchId)
  - Если nextMatchId = null → турнир завершён
  - Определение слота (player1 или player2) по чётности position
  - Обновление следующего матча
  - Для double elimination: проигравший в losers bracket

- `checkTournamentCompletion(tournamentId)` - Проверка завершения турнира
  - Для single_elimination: финал завершён
  - Для double_elimination: grand final завершён
  - Для round_robin: все матчи завершены

- `getMatchStats(tournamentId)` - Статистика матчей турнира
  - Всего матчей
  - Завершено
  - В процессе
  - Запланировано

#### bracketGenerator.ts

Генерация турнирной сетки.

**Основные функции:**

- `generateBracket(format, participants)` - Генерация сетки
  - Поддержка форматов:
    - `single_elimination` - Олимпийская система
    - `double_elimination` - Двойная элиминация
    - `round_robin` - Круговая система
  - Возвращает массив `BracketMatch[]`

- `getBracketStats(format, participantsCount)` - Статистика сетки
  - Количество матчей
  - Количество раундов

- `getRoundName(round, totalRounds, format, bracketType)` - Название раунда
  - "Раунд 1 из 4"
  - "1/4 финала"
  - "Полуфинал"
  - "Финал"
  - "Гранд-финал" (для double elimination)

- `getNextPowerOfTwo(n)` - Ближайшая степень двойки
  - Для определения размера сетки

- `calculateRounds(bracketSize)` - Количество раундов
  - log2(bracketSize)

**Алгоритм single elimination:**

1. Определение размера сетки (ближайшая степень двойки)
2. Расстановка участников согласно seeds
3. Bye для отсутствующих слотов
4. Создание связей между матчами (nextMatchId)
5. Определение position для каждого матча

**Структура BracketMatch:**

```typescript
interface BracketMatch {
  round: number;            // Номер раунда (1, 2, 3...)
  position: number;         // Позиция в общей сетке
  player1Id?: string;       // ID первого игрока
  player2Id?: string;       // ID второго игрока
  bracketType: string;      // "winners", "losers", "grand_final"
  nextMatchId?: number;     // Позиция следующего матча
}
```

#### notificationService.ts

Сервис уведомлений (в разработке).

Планируемые функции:
- Уведомления о начале турнира
- Уведомления о начале матча
- Уведомления о необходимости подтверждения результата
- Напоминания о предстоящих матчах

#### timeoutService.ts

Сервис таймаутов (в разработке).

Планируемые функции:
- Автоматическое завершение матчей при просрочке
- Дисквалификация за неявку
- Напоминания о дедлайнах

### Middleware

#### authMiddleware

Расположение: [src/bot/middleware/auth.ts](src/bot/middleware/auth.ts)

**Функции:**
- Проверка наличия пользователя в БД
- Создание записи при первом обращении
- Обогащение контекста объектом `dbUser`
- Синхронизация username и telegram_id

**Поток:**
```
Входящее сообщение
    ↓
authMiddleware
    ↓
Поиск в БД по telegram_id
    ↓
┌───────┴────────┐
│                │
Найден        Не найден
│                │
│                ↓
│          Создание записи
│          role = "user"
│                │
└────────┬───────┘
         ↓
Обновление username
         ↓
ctx.dbUser = user
         ↓
next()
```

### Guards

#### adminOnly()

Расположение: [src/bot/guards.ts](src/bot/guards.ts)

**Функции:**
- Проверка роли пользователя
- Блокировка доступа для не-админов

**Использование:**
```typescript
tournamentCommands.command("create_tournament", adminOnly(), async (ctx) => {
  // Только для админов
});
```

### UI компоненты

#### tournamentUI.ts

Функции для формирования сообщений и клавиатур:

- `getTournamentInfo(tournament, userId)` - Информация о турнире с участием пользователя
- `buildTournamentMessage(info, isAdmin)` - Формирование сообщения о турнире
- `buildTournamentKeyboard(info, isAdmin)` - Клавиатура для турнира
- `buildTournamentListItem(info, isAdmin)` - Элемент списка турниров
- `buildTournamentListKeyboard(tournaments)` - Клавиатура списка турниров
- `buildTournamentSelectionKeyboard(tournaments)` - Клавиатура выбора турнира

### Wizards

#### tournamentCreationWizard

Мастер создания турнира с пошаговым сбором данных.

**Состояние хранится в памяти (Map):**
```typescript
interface CreationState {
  step: "name" | "date" | "discipline" | "format" | "maxParticipants" | "winScore";
  lastMessageId?: number;
  data: CreationData;
}
```

**Шаги:**
1. Название (текстовый ввод)
2. Дата (текстовый ввод с парсингом)
3. Дисциплина (inline кнопки)
4. Формат (inline кнопки)
5. Кол-во участников (inline кнопки)
6. До скольки побед (inline кnопки)

**Отмена:**
- Команда `/cancel` удаляет состояние из Map

---

## Особенности реализации

### Статусы турнира

```
draft → registration_open → registration_closed → in_progress → completed
   ↓                                                                ↓
cancelled ←───────────────────────────────────────────────────── cancelled
```

- `draft` - Черновик, турнир создан, но регистрация не открыта
- `registration_open` - Регистрация открыта, участники могут регистрироваться
- `registration_closed` - Регистрация закрыта, можно запускать турнир
- `in_progress` - Турнир идёт, матчи проводятся
- `completed` - Турнир завершён, победитель определён
- `cancelled` - Турнир отменён

### Статусы матча

```
scheduled → in_progress → pending_confirmation → completed
                ↑               ↓
                └─── dispute ───┘
```

- `scheduled` - Запланирован, оба игрока определены
- `in_progress` - Матч начат, игроки могут вносить результат
- `pending_confirmation` - Результат внесён, ожидает подтверждения соперника
- `completed` - Матч завершён, результат подтверждён
- `cancelled` - Матч отменён

### Двухфазное подтверждение результатов

1. **Репорт (reportResult):**
   - Один игрок вносит результат
   - Статус → `pending_confirmation`
   - Сохраняется reportedBy

2. **Подтверждение (confirmResult):**
   - Соперник подтверждает
   - Статус → `completed`
   - Сохраняется confirmedBy
   - Победитель продвигается дальше

3. **Оспаривание (disputeResult):**
   - Соперник оспаривает
   - Статус → `in_progress`
   - Результат обнуляется
   - Требуется вмешательство судьи

### Продвижение победителя

**Алгоритм:**

1. Получение текущего матча
2. Проверка наличия winnerId
3. Проверка наличия nextMatchId
4. Если nextMatchId = null → турнир завершён
5. Определение слота в следующем матче:
   - position % 2 == 1 → player1Id
   - position % 2 == 0 → player2Id
6. Обновление следующего матча
7. Проверка готовности следующего матча

**Пример:**
```
Матч #1 (position=1): player1 vs player2
Матч #2 (position=2): player3 vs player4
    ↓
Матч #5 (position=5): winner(#1) vs winner(#2)
```

- Победитель матча #1 (position=1, нечётная) → player1Id матча #5
- Победитель матча #2 (position=2, чётная) → player2Id матча #5

### Генерация турнирной сетки

**Single Elimination (Олимпийская система):**

```
Участников: 8, Сетка: 8, Раундов: 3

Раунд 1 (4 матча):
  #1: Seed 1 vs Seed 8
  #2: Seed 4 vs Seed 5
  #3: Seed 2 vs Seed 7
  #4: Seed 3 vs Seed 6

Раунд 2 (2 матча):
  #5: Winner(#1) vs Winner(#2)
  #6: Winner(#3) vs Winner(#4)

Раунд 3 (1 матч):
  #7: Winner(#5) vs Winner(#6) - Финал
```

**Если участников меньше степени двойки (например, 6):**

```
Участников: 6, Сетка: 8, Раундов: 3

Раунд 1 (2 матча):
  #1: Seed 4 vs Seed 5
  #2: Seed 3 vs Seed 6

Раунд 2 (4 матча):
  #3: Seed 1 vs Winner(#1)  ← Seed 1 получил Bye
  #4: Seed 2 vs Winner(#2)  ← Seed 2 получил Bye
  #5: (уже определены из R1)
  #6: (уже определены из R1)

Раунд 3 (1 матч):
  #7: Winner(#3) vs Winner(#4) - Финал
```

### Технические результаты

Администратор или судья может установить технический результат:

**Причины:**
- `walkover` - Отказ от игры (технический проигрыш)
- `no_show` - Неявка соперника
- `forfeit` - Добровольный отказ

**Процесс:**
1. Админ открывает меню тех. результата
2. Выбирает победителя
3. Система устанавливает счёт: winScore:0
4. Флаг `isTechnicalResult = true`
5. Указывается `technicalReason`
6. Матч завершается, победитель продвигается

### Безопасность и проверки

**На уровне команд:**
- Middleware `authMiddleware` для всех запросов
- Guard `adminOnly()` для административных команд
- Проверка ролей через `isAdmin(ctx)`

**На уровне бизнес-логики:**
- Проверка существования сущностей (турнир, матч, пользователь)
- Проверка статусов перед операциями
- Валидация участия пользователя в матче
- Проверка лимитов (максимум участников)
- Валидация счёта (один должен = winScore)

**На уровне БД:**
- Foreign keys для целостности данных
- Уникальные индексы (telegram_id)
- NOT NULL для обязательных полей
- Каскадное удаление для связанных данных

### Обработка ошибок

**В обработчиках:**
```typescript
try {
  // Операция
} catch (error) {
  console.error("Error:", error);
  await ctx.reply("Произошла ошибка");
}
```

**В сервисах:**
```typescript
return {
  success: false,
  error: "Описание ошибки"
};
```

**В callback query:**
```typescript
await ctx.answerCallbackQuery({
  text: "Описание ошибки",
  show_alert: true  // Модальное окно
});
```

---

## Планы развития

### Запланированные функции

1. **Система уведомлений**
   - Уведомления о начале турнира
   - Уведомления о готовности матча
   - Напоминания о подтверждении результата

2. **Таймауты и дисквалификации**
   - Автоматическая дисквалификация за неявку
   - Таймауты на подтверждение результата
   - Система предупреждений

3. **Расширенная статистика**
   - Рейтинг игроков
   - История матчей
   - Процент побед
   - Статистика по дисциплинам

4. **Дополнительные форматы**
   - Swiss system
   - Group stage + playoffs
   - Custom formats

5. **Улучшение UX**
   - Визуализация сетки
   - Экспорт турнирной таблицы
   - История турниров
   - Поиск по турнирам

6. **Интеграции**
   - Экспорт в Challonge
   - Интеграция с рейтинговыми системами
   - Webhook уведомления

7. **Персистентные сессии**
   - Хранение wizard состояний в БД
   - Восстановление после перезапуска

### Технический долг

- [ ] Типизация всех callback query данных
- [ ] Централизованная обработка ошибок
- [ ] Логирование операций
- [ ] Тесты (unit + integration)
- [ ] Миграция wizard состояний в БД
- [ ] Оптимизация запросов (N+1 проблема)
- [ ] Кэширование часто запрашиваемых данных
- [ ] Rate limiting
- [ ] Интернационализация (i18n)

---

## Заключение

Данная документация описывает текущее состояние проекта Cue Bot по состоянию на январь 2026 года. Система предоставляет полный функционал для проведения турниров по бильярду с автоматизацией большинства процессов.

Основные преимущества:
- Полная автоматизация турнирной сетки
- Двухфазное подтверждение результатов
- Гибкая система ролей
- Поддержка нескольких форматов турниров
- Интуитивно понятный интерфейс через Telegram

Система готова к использованию в реальных условиях с возможностью дальнейшего расширения функционала.
